if EXISTS (SELECT 1 FROM   sys.objects WHERE  object_id = OBJECT_ID('dbo.fnSplitString') AND type IN (N'FN', N'IF', N'TF', N'FS', N'FT',N'P')) DROP FUNCTION [dbo].[fnSplitString];
exec('Create FUNCTION [dbo].[fnSplitString]
(@string NVARCHAR(MAX), @delimiter CHAR(1)) RETURNS @output TABLE (splitdata NVARCHAR(MAX)) BEGIN DECLARE @start bigint, @end bigint SELECT @start = 1, @end = CHARINDEX(@delimiter, @string) WHILE @start < LEN(@string) + 1 BEGIN IF @end = 0 SET @end = LEN(@string) + 1 INSERT INTO @output (splitdata) VALUES(SUBSTRING(@string, @start, @end - @start)) SET @start = @end + 1 SET @end = CHARINDEX(@delimiter, @string, @start) END RETURN END') 
